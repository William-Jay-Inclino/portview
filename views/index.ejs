<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Portview</title>
    <style>
      :root {
        --bg: #f6f7fb;
        --card: #ffffff;
        --text: #111827;
        --muted: #4b5563;
        --border: #e5e7eb;
        --shadow: 0 10px 30px rgba(0,0,0,0.08);
        --primary: #111827;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Helvetica Neue", Helvetica, sans-serif;
        color: var(--text);
        background: var(--bg);
      }
      .container {
        max-width: 980px;
        margin: 0 auto;
        padding: 28px 18px 36px;
      }
      .header {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 14px;
      }
      h1 { margin: 0; font-size: 22px; letter-spacing: -0.01em; }
      .tag {
        font-size: 12px;
        color: var(--muted);
        border: 1px solid var(--border);
        background: #fff;
        padding: 4px 10px;
        border-radius: 999px;
        white-space: nowrap;
      }
      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 14px;
        box-shadow: var(--shadow);
        padding: 16px;
      }
      .hint {
        color: var(--muted);
        margin: 0 0 14px;
        line-height: 1.45;
      }
      .hint strong { color: var(--text); }
      .formRow {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
      }
      input[type="file"] {
        flex: 1;
        min-width: 240px;
        padding: 10px;
        border: 1px dashed var(--border);
        border-radius: 10px;
        background: #fafafa;
      }
      button {
        appearance: none;
        border: 1px solid #0f172a;
        background: var(--primary);
        color: #fff;
        border-radius: 10px;
        padding: 10px 14px;
        cursor: pointer;
        font-weight: 600;
      }
      button[disabled] {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .meta {
        margin-top: 10px;
        font-size: 12px;
        color: var(--muted);
      }
      .status {
        margin-top: 12px;
        font-size: 13px;
        color: var(--muted);
      }
      .status.error { color: #b91c1c; }
      .status.ok { color: #065f46; }
      .viewer {
        margin-top: 14px;
        border: 1px solid var(--border);
        border-radius: 12px;
        overflow: hidden;
        background: #fff;
      }
      iframe { width: 100%; height: 72vh; border: 0; display: block; }
      code { background: #f3f4f6; padding: 1px 6px; border-radius: 6px; }

      .footer {
        margin-top: 16px;
        display: flex;
        justify-content: space-between;
        gap: 12px;
        flex-wrap: wrap;
        color: var(--muted);
        font-size: 12px;
      }
      .footer a { color: inherit; text-decoration: underline; }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>Portview</h1>
        <div class="tag">FMSEC Ledger â†’ Cashflow PDF</div>
      </div>

      <div class="card">
        <p class="hint">
          Upload a yearly ledger. Only FirstMetroSec is supported for now.
          Choose a year, then upload the matching file type to generate a cashflow PDF.
          <strong>Important:</strong> Remove any password from the file before uploading so the app can parse it.
        </p>

        <form id="uploadForm">
          <div class="formRow">
            <label for="year" style="font-size:12px;color:var(--muted)">Year</label>
            <select id="year" required style="padding:10px;border:1px solid var(--border);border-radius:10px;background:#fff">
              <option value="2024" selected>2024</option>
              <option value="2025">2025</option>
            </select>
            <input id="file" type="file" required />
            <button id="submitBtn" type="submit">Generate PDF</button>
          </div>
          <div id="helper" class="meta"></div>
        </form>

        <div id="status" class="status"></div>

        <div class="viewer">
          <iframe id="pdfFrame" title="Generated PDF"></iframe>
        </div>

        <div class="footer">
          <div>Developed by William Jay Inclino.</div>
          <div>If you have any concerns, feel free to email <a href="mailto:wjay.inclino@gmail.com">wjay.inclino@gmail.com</a>.</div>
        </div>
      </div>
    </div>

    <script>
      const BASE_PATH = "<%= basePath %>";
      const form = document.getElementById('uploadForm');
      const yearEl = document.getElementById('year');
      const fileInput = document.getElementById('file');
      const helperEl = document.getElementById('helper');
      const statusEl = document.getElementById('status');
      const frame = document.getElementById('pdfFrame');
      const submitBtn = document.getElementById('submitBtn');
      let lastObjectUrl = null;

      const YEAR_RULES = {
        2024: { accept: '.csv,.xlsx,.xls', label: 'Upload a FirstMetroSec yearly ledger (.csv or .xlsx). Tip: larger ledgers may take a few seconds to render.' },
        2025: { accept: '.pdf', label: 'Upload a FirstMetroSec Statement of Account PDF for 2025 (.pdf). The app will extract cash movements and compute monthly deposits/withdrawals/dividends.' },
      };

      function getSelectedYear() {
        const y = Number(yearEl && yearEl.value);
        return Number.isFinite(y) ? y : 2024;
      }

      function getFileExt(name) {
        const s = String(name || '').trim();
        const idx = s.lastIndexOf('.');
        return idx === -1 ? '' : s.slice(idx + 1).toLowerCase();
      }

      function updateYearUi() {
        const year = getSelectedYear();
        const rule = YEAR_RULES[year] || YEAR_RULES[2024];
        fileInput.setAttribute('accept', rule.accept);
        helperEl.textContent = rule.label;
        // Clear any previously selected file if it no longer matches.
        const f = fileInput.files && fileInput.files[0];
        if (f) {
          const ext = getFileExt(f.name);
          const ok = (year === 2024 && (ext === 'csv' || ext === 'xlsx' || ext === 'xls')) || (year === 2025 && ext === 'pdf');
          if (!ok) fileInput.value = '';
        }
      }

      yearEl.addEventListener('change', () => {
        updateYearUi();
        setStatus('');
      });

      updateYearUi();

      function setStatus(msg, kind) {
        statusEl.textContent = msg || '';
        statusEl.className = kind ? `status ${kind}` : 'status';
      }

      function setBusy(busy) {
        submitBtn.disabled = !!busy;
        fileInput.disabled = !!busy;
      }

      function readFileAsDataUrl(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onerror = () => reject(new Error('Failed to read file'));
          reader.onload = () => resolve(String(reader.result || ''));
          reader.readAsDataURL(file);
        });
      }

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const file = fileInput.files && fileInput.files[0];
        if (!file) return;

        const year = getSelectedYear();
        const ext = getFileExt(file.name);
        const isValid2024 = year === 2024 && (ext === 'csv' || ext === 'xlsx' || ext === 'xls');
        const isValid2025 = year === 2025 && ext === 'pdf';
        if (!isValid2024 && !isValid2025) {
          setStatus(year === 2025
            ? 'Error: For 2025, only .pdf files are accepted.'
            : 'Error: For 2024, only .csv or .xlsx files are accepted.', 'error');
          return;
        }

        try {
          setBusy(true);
          setStatus('Generating PDF...');
          frame.removeAttribute('src');
          if (lastObjectUrl) URL.revokeObjectURL(lastObjectUrl);
          lastObjectUrl = null;

          const dataUrl = await readFileAsDataUrl(file);

          const resp = await fetch(`${BASE_PATH}/api/report/fmsec/pdf`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              filename: file.name,
              dataBase64: dataUrl,
              year,
            }),
          });

          if (!resp.ok) {
            const text = await resp.text().catch(() => '');
            throw new Error(text || `Request failed: ${resp.status}`);
          }

          const blob = await resp.blob();
          lastObjectUrl = URL.createObjectURL(blob);
          frame.src = lastObjectUrl;
          setStatus('Done.', 'ok');
        } catch (err) {
          setStatus(`Error: ${err && err.message ? err.message : String(err)}`, 'error');
        } finally {
          setBusy(false);
        }
      });
    </script>
  </body>
</html>
